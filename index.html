<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Lab 3 - Ramallah Zones & Waste Containers</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- jQuery for Ajax -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // إنشاء الخريطة وتحديد مركزها
    var map = L.map('map').setView([31.9, 35.2], 12);

    // طبقة الأساس
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // متغيرات نخزن فيها الطبقات عشان نستخدمها بالـ Layer Control
    var zonesLayer;
    var wasteContainersLayer;
    var layerControl; // عشان نقدر نحدّث الـ control بعد تحميل الطبقات

    // دالة لتحديث الـ Layer Control بعد ما تنعمل الطبقات
    function updateLayerControl() {
        // لو كان فيه كنترول قديم، نمسحه
        if (layerControl) {
            map.removeControl(layerControl);
        }

        const baseLayers = {};
        const overlays = {};

        if (zonesLayer) {
            overlays["Zones"] = zonesLayer;
        }
        if (wasteContainersLayer) {
            overlays["Waste Containers"] = wasteContainersLayer;
        }

        layerControl = L.control.layers(baseLayers, overlays).addTo(map);
    }

    // =====================
    // STEP 1 + STEP 2 + STEP 3
    // =====================

    $.getJSON("RamallahZones.json", function (RZ) {
        zonesLayer = L.geoJson(RZ, {
            style: function (feature) {
                return {
                    fillColor: "yellow",
                    fillOpacity: 0.3,
                    color: "yellow",
                    weight: 1.0,
                    opacity: 0.7
                };
            },
            onEachFeature: function (feature, layer) {
                // STEP 2 + STEP 3: إظهار اسم المنطقة + MAIL_CODE
                layer.on('click', function (e) {
                    alert(
                        "Zone: " + (feature.properties.NAME_ENGLI || feature.properties.NAME) +
                        "\nMAIL_CODE: " + (feature.properties.MAIL_CODE || "")
                    );
                });
            }
        }).addTo(map);

        // تقريب الخريطة على كل المناطق
        map.fitBounds(zonesLayer.getBounds());

        // نحدّث Layer Control
        updateLayerControl();
    });

    // =====================
    // STEP 4
    // =====================

    $.getJSON("wasteContainer.json", function (WC) {
        wasteContainersLayer = L.geoJson(WC, {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 5,
                    fillColor: "orange",
                    color: "orange",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            }
        }).addTo(map);

        // بعد ما تنعمل الطبقة، نحدّث Layer Control
        updateLayerControl();
    });

    // =====================
    // STEP 5 (موجود داخل updateLayerControl)
    // - عمل Layer Control
    // - إضافة الطبقتين على الخريطة
    // =====================

</script>

</body>
</html>
